version: '3.8'

# Worktree Docker Compose Configuration
# This file is completely standalone (does NOT extend main docker-compose.yml)
# Generated by worktree-manager skill

services:
  backend:
    build:
      context: {{MAIN_PROJECT_PATH}}/backend
      dockerfile: Dockerfile.dev
    container_name: backend-{{WORKTREE_NAME}}
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - {{WORKTREE_PATH}}/backend:/app
    ports:
      - "{{BACKEND_PORT}}:3000"
    environment:
      - RAILS_ENV=development
      - DATABASE_URL=postgres://arlenagreer:y06dgy4v@db:5432/softrak_{{WORKTREE_NAME}}
      - BUNDLE_APP_CONFIG=/app/.bundle
      - REDIS_URL=  # Explicitly disable Redis for development
      - DISABLE_REDIS=true
      - DISABLE_RATE_LIMITING=true
      - DISABLE_RACK_ATTACK=true
    env_file:
      - {{WORKTREE_PATH}}/backend/.env
    tty: true
    stdin_open: true
    depends_on:
      - db

  frontend:
    build:
      context: {{MAIN_PROJECT_PATH}}/frontend
      dockerfile: Dockerfile.dev
    container_name: frontend-{{WORKTREE_NAME}}
    ports:
      - "{{FRONTEND_PORT}}:4000"
    volumes:
      # Mount source files for development but exclude node_modules
      - {{WORKTREE_PATH}}/frontend/src:/app/src
      - {{WORKTREE_PATH}}/frontend/public:/app/public
      - {{WORKTREE_PATH}}/frontend/index.html:/app/index.html
      - {{WORKTREE_PATH}}/frontend/vite.config.ts:/app/vite.config.ts
      - {{WORKTREE_PATH}}/frontend/tsconfig.json:/app/tsconfig.json
      - {{WORKTREE_PATH}}/frontend/tsconfig.node.json:/app/tsconfig.node.json
      - {{WORKTREE_PATH}}/frontend/tailwind.config.js:/app/tailwind.config.js
      - {{WORKTREE_PATH}}/frontend/postcss.config.js:/app/postcss.config.js
      - {{WORKTREE_PATH}}/frontend/package.json:/app/package.json
      - {{WORKTREE_PATH}}/frontend/.env:/app/.env
      # Use named volume for node_modules to preserve container dependencies
      - frontend_node_modules_{{WORKTREE_NAME}}:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:{{BACKEND_PORT}}
    depends_on:
      - backend

  db:
    image: postgres:16-alpine
    container_name: db-{{WORKTREE_NAME}}
    ports:
      - "{{DB_PORT}}:5432"
    environment:
      - POSTGRES_USER=arlenagreer
      - POSTGRES_PASSWORD=y06dgy4v
      - POSTGRES_DB=softrak_{{WORKTREE_NAME}}
    volumes:
      - db_data_{{WORKTREE_NAME}}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arlenagreer"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis-{{WORKTREE_NAME}}
    ports:
      - "{{REDIS_PORT}}:6379"
    volumes:
      - redis_data_{{WORKTREE_NAME}}:/data
    # Override the command to exit immediately instead of running Redis (development only)
    command: /bin/sh -c "echo 'Redis disabled for development' && exit 0"

volumes:
  db_data_{{WORKTREE_NAME}}:
  redis_data_{{WORKTREE_NAME}}:
  frontend_node_modules_{{WORKTREE_NAME}}:

# Note: This file is NOT committed to Git
# It is generated per-worktree for development isolation
# Each worktree gets its own database and Redis instance
